# Implementation Plan: TTS API Wrapper

**Branch**: `001-tts-api-wrapper` | **Date**: 2025-12-03 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-tts-api-wrapper/spec.md`

## Summary

Build a Go-based TTS API wrapper service that provides:
- **Sync endpoint** (`POST /api/v1/tts`) for short text (< 5,000 chars) with direct audio response
- **Async job queue** (`POST /api/v1/jobs`) for longer text with polling and result retrieval
- **ElevenLabs integration** as primary provider with multi-provider architecture
- **API patterns** matching existing Pako Transcriber for consistency

## Technical Context

**Language/Version**: Go 1.23 (latest stable)
**Primary Dependencies**: Chi router (v5.1.0), Viper (config), Zap (logging), UUID
**Storage**: Local filesystem for audio cache (24h retention)
**Testing**: Go testing + testify, httptest for handlers
**Target Platform**: Linux server (Docker-ready)
**Project Type**: Single Go module
**Performance Goals**: < 5s sync response for 1000 chars, 100 concurrent jobs
**Constraints**: 30s sync timeout, 24h result retention
**Scale/Scope**: Single instance initially, horizontally scalable via job queue

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Evidence |
|-----------|--------|----------|
| I. Interface-First Design | ✅ PASS | Interfaces defined: TTSProvider, JobQueue, AudioStorage |
| II. Ports & Adapters | ✅ PASS | ElevenLabs adapter implements TTSProvider port |
| III. Test-First Mindset | ✅ PASS | Contract tests planned for all interfaces |
| IV. Simplicity & YAGNI | ✅ PASS | In-memory queue first, no premature Redis |
| V. Code Reuse | ✅ PASS | Patterns from transcriber project reused |
| VI. Quality Standards | ✅ PASS | golangci-lint, gofmt, structured logging planned |

**Go Development Standards**:
- ✅ Go modules for dependencies
- ✅ Explicit error handling with context wrapping
- ✅ Structured logging with request IDs
- ✅ Environment-based configuration
- ✅ Godoc comments for public APIs

## Project Structure

### Documentation (this feature)

```text
specs/001-tts-api-wrapper/
├── plan.md              # This file
├── research.md          # Technology decisions and rationale
├── data-model.md        # Entity definitions and schemas
├── quickstart.md        # API usage guide
├── contracts/
│   └── openapi.yaml     # OpenAPI 3.1 specification
└── tasks.md             # Generated by /speckit.tasks
```

### Source Code (repository root)

```text
cmd/
└── server/
    └── main.go              # Entry point, server setup

internal/
├── api/
│   ├── handlers/
│   │   ├── health.go        # GET /api/v1/health
│   │   ├── tts.go           # POST /api/v1/tts (sync)
│   │   ├── jobs.go          # Job CRUD handlers
│   │   └── providers.go     # GET /api/v1/providers
│   ├── middleware/
│   │   ├── logging.go       # Request logging
│   │   └── error.go         # Error response formatting
│   └── routes.go            # Route registration
├── domain/
│   ├── job.go               # Job entity and status
│   ├── provider.go          # TTSProvider interface (port)
│   ├── queue.go             # JobQueue interface (port)
│   ├── storage.go           # AudioStorage interface (port)
│   └── voice.go             # Voice and VoiceSettings
├── provider/
│   └── elevenlabs/
│       ├── client.go        # HTTP client for ElevenLabs API
│       ├── provider.go      # TTSProvider implementation
│       └── voices.go        # Voice mapping
├── queue/
│   └── memory/
│       ├── queue.go         # In-memory JobQueue implementation
│       └── worker.go        # Background worker pool
└── storage/
    └── filesystem/
        └── storage.go       # Filesystem AudioStorage implementation

pkg/
└── config/
    └── config.go            # Viper-based configuration

tests/
├── contract/
│   ├── provider_test.go     # TTSProvider contract tests
│   └── queue_test.go        # JobQueue contract tests
└── integration/
    ├── tts_test.go          # Sync endpoint tests
    └── jobs_test.go         # Job workflow tests

go.mod
go.sum
Makefile
Dockerfile
.env.example
```

**Structure Decision**: Standard Go project layout with `cmd/` for entry points, `internal/` for private packages following ports & adapters architecture, and `pkg/` for reusable utilities.

## Complexity Tracking

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| TTSProvider interface | Required by constitution for multi-provider support | Direct ElevenLabs calls would prevent adding providers |
| JobQueue interface | Required for testability and future Redis migration | Hard-coded in-memory would block scaling |
| AudioStorage interface | Required for testability and future S3 migration | Direct filesystem calls would block cloud deployment |

**Note**: These abstractions are justified by constitution principles II (Ports & Adapters) and explicit requirement FR-009 (multiple providers).

## Phase Outputs

| Phase | Artifact | Status |
|-------|----------|--------|
| Phase 0 | research.md | ✅ Complete |
| Phase 1 | data-model.md | ✅ Complete |
| Phase 1 | contracts/openapi.yaml | ✅ Complete |
| Phase 1 | quickstart.md | ✅ Complete |
| Phase 2 | tasks.md | Pending `/speckit.tasks` |

## Next Steps

Run `/speckit.tasks` to generate the implementation task list based on this plan.